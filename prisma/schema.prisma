

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

///////////////////////////////
// ENUMS
///////////////////////////////

enum EmailFolder {
  INBOX
  SENT
  DRAFT
  TRASH
  SPAM
}

enum OpportunityStage {
  LEAD
  PROPOSAL
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

enum AIActionType {
  SUMMARY
  REPLY_DRAFT
  SENTIMENT
  CLASSIFICATION
  FOLLOWUP_SUGGESTION
}

enum IntegrationType {
  GOOGLE
  OUTLOOK
  SMTP
  OTHER
}

enum TrainingType {
  TEXT
  FILE
  FAQ
}

enum HallucinationSeverity {
  LOW
  MEDIUM
  HIGH
}

enum HallucinationStatus {
  OPEN
  FIXED
  DISMISSED
}

///////////////////////////////
// BUSINESS (TENANT)
///////////////////////////////

model Business {
  id         Int      @id @default(autoincrement())
  name       String
  email      String?
  website    String?
  status     String?  @default("ACTIVE")
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Stripe Billing
  stripe_customer_id String?

  // ⭐ Round Robin – last assigned agent
  last_assigned_user_id Int? // only used as scalar for round robin pointer

  // Relations
  users         User[]
  mailboxes     Mailbox[]
  threads       EmailThread[]
  emails        Email[]
  customers     Customer[]
  opportunities Opportunity[]
  integrations  Integration[]

  // AI
  aiTraining     AiTrainingData[]
  aiReplies      AiGeneratedReply[]
  hallucinations AiHallucinationReport[]

  // Billing
  subscriptions Subscription[]
  payments      PaymentHistory[]
}

///////////////////////////////
// ROLE & USER
///////////////////////////////

model Role {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?

  users User[]
}

model User {
  id                 Int       @id @default(autoincrement())
  name               String
  email              String    @unique
  password_hash      String
  status             String?   @default("ACTIVE")
  two_factor_enabled Boolean   @default(false)
  last_login_at      DateTime?
  refreshToken       String?
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt

  // FK
  role_id     Int
  business_id Int?

  // Relations
  role     Role      @relation(fields: [role_id], references: [id])
  business Business? @relation(fields: [business_id], references: [id])

  // Email-related
  mailboxes Mailbox[]
  emails    Email[]
  aiActions AIAction[]

  // AI Back-relations
  aiReplies      AiGeneratedReply[]
  hallucinations AiHallucinationReport[]

  // ⭐ Round Robin – all threads assigned to this agent
  assignedThreads EmailThread[] @relation("AssignedAgent")
}

///////////////////////////////
// MAILBOX
///////////////////////////////

model Mailbox {
  id            Int      @id @default(autoincrement())
  business_id   Int
  user_id       Int
  provider      String
  email_address String
  imap_host     String?
  imap_port     Int?
  smtp_host     String?
  smtp_port     Int?
  is_ssl        Boolean? @default(true)
  created_at    DateTime @default(now())

  business Business @relation(fields: [business_id], references: [id])
  user     User     @relation(fields: [user_id], references: [id])

  threads EmailThread[]
  emails  Email[]
}

///////////////////////////////
// EMAIL THREAD
///////////////////////////////

model EmailThread {
  id              Int      @id @default(autoincrement())
  business_id     Int
  mailbox_id      Int
  customer_id     Int?
  subject         String
  last_message_at DateTime

  // Thread states
  is_archived Boolean @default(false)

  // Assigned agent (Round Robin / manual)
  assigned_user_id Int?
  assigned_user    User? @relation("AssignedAgent", fields: [assigned_user_id], references: [id])

  // Relations
  emails   Email[]
  mailbox  Mailbox   @relation(fields: [mailbox_id], references: [id])
  business Business  @relation(fields: [business_id], references: [id])
  customer Customer? @relation(fields: [customer_id], references: [id])

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

// OLD VERSION (kept only for history, but commented out)
//
// model EmailThread {
//   id              Int       @id @default(autoincrement())
//   business_id     Int
//   mailbox_id      Int
//   customer_id     Int?
//   subject         String?
//   last_message_at DateTime?
//   created_at      DateTime  @default(now())
//   updated_at      DateTime  @updatedAt
//
//   business Business  @relation(fields: [business_id], references: [id])
//   mailbox  Mailbox   @relation(fields: [mailbox_id], references: [id])
//   customer Customer? @relation(fields: [customer_id], references: [id])
//
//   emails Email[]
// }

///////////////////////////////
// EMAIL
///////////////////////////////

model Email {
  id          Int  @id @default(autoincrement())
  business_id Int
  mailbox_id  Int
  thread_id   Int
  user_id     Int?

  message_id    String?
  in_reply_to   String?
  from_address  String?
  to_addresses  Json?
  cc_addresses  Json?
  bcc_addresses Json?
  subject       String?
  body_html     String?
  body_text     String?
  folder        EmailFolder?
  is_read       Boolean?     @default(false)
  is_starred    Boolean?     @default(false)
  received_at   DateTime?
  sent_at       DateTime?
  created_at    DateTime     @default(now())
  updated_at    DateTime     @updatedAt

  business Business    @relation(fields: [business_id], references: [id])
  mailbox  Mailbox     @relation(fields: [mailbox_id], references: [id])
  thread   EmailThread @relation(fields: [thread_id], references: [id])
  user     User?       @relation(fields: [user_id], references: [id])

  insight   AIEmailInsight?
  aiActions AIAction[]

  aiReplies      AiGeneratedReply[]
  hallucinations AiHallucinationReport[]
}

///////////////////////////////
// CRM MODELS
///////////////////////////////

model Customer {
  id          Int     @id @default(autoincrement())
  business_id Int
  name        String
  email       String?
  phone       String?

  // CRM fields
  status         String? // LEAD | CLIENT | INACTIVE | CHURNED etc.
  lead_score     Int? // 0–100 (AI score)
  value_estimate Float? // total estimated deal value

  // Activity
  last_contact_at DateTime?

  // Extra (AI + CRM friendly)
  source             String? // "SUBSCRIPTION", "INBOUND_EMAIL", "IMPORT", etc.
  company            String?
  notes              String?
  preferred_language String? // "en", "bn", etc.
  tags               Json? // e.g. ["premium","hot","returning"]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  business      Business      @relation(fields: [business_id], references: [id])
  threads       EmailThread[]
  opportunities Opportunity[]

  @@unique([business_id, email], name: "business_email_unique")
  // Optional but very useful for lookup
  @@index([business_id])
  @@index([email])
}

model Opportunity {
  id           Int              @id @default(autoincrement())
  business_id  Int
  customer_id  Int
  name         String
  stage        OpportunityStage
  value_amount Float?
  status       String?
  created_at   DateTime         @default(now())

  business Business @relation(fields: [business_id], references: [id])
  customer Customer @relation(fields: [customer_id], references: [id])
}

// OLD VERSIONS (commented)
// model Customer {
//   id              Int       @id @default(autoincrement())
//   business_id     Int
//   name            String
//   email           String?
//   phone           String?
//   status          String?
//   lead_score      Int?
//   value_estimate  Float?
//   last_contact_at DateTime?
//
//   business      Business      @relation(fields: [business_id], references: [id])
//   threads       EmailThread[]
//   opportunities Opportunity[]
// }

// model Opportunity {
//   id           Int              @id @default(autoincrement())
//   business_id  Int
//   customer_id  Int
//   name         String
//   stage        OpportunityStage
//   value_amount Float?
//   status       String?
//   created_at   DateTime         @default(now())
//
//   business Business @relation(fields: [business_id], references: [id])
//   customer Customer @relation(fields: [customer_id], references: [id])
// }

///////////////////////////////
// AI MODELS
///////////////////////////////

model AIEmailInsight {
  id                Int      @id @default(autoincrement())
  email_id          Int      @unique
  summary           String?
  suggested_actions String?
  created_at        DateTime @default(now())

  email Email @relation(fields: [email_id], references: [id])
}

model AIAction {
  id          Int          @id @default(autoincrement())
  email_id    Int
  user_id     Int?
  action_type AIActionType
  created_at  DateTime     @default(now())

  email Email @relation(fields: [email_id], references: [id])
  user  User? @relation(fields: [user_id], references: [id])
}

model AiGeneratedReply {
  id          Int  @id @default(autoincrement())
  email_id    Int
  user_id     Int?
  business_id Int

  content    String
  tone       String?
  model      String?
  confidence Float?
  status     String? @default("SUGGESTED")

  created_at DateTime @default(now())

  email    Email    @relation(fields: [email_id], references: [id])
  user     User?    @relation(fields: [user_id], references: [id])
  business Business @relation(fields: [business_id], references: [id])

  hallucinations AiHallucinationReport[]
}

model AiTrainingData {
  id          Int          @id @default(autoincrement())
  business_id Int
  type        TrainingType
  content     String?
  file_url    String?
  tags        Json?
  approved_by Int?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  business Business @relation(fields: [business_id], references: [id])
}

model AiHallucinationReport {
  id          Int  @id @default(autoincrement())
  email_id    Int
  reply_id    Int?
  user_id     Int
  business_id Int

  issue_type String
  comment    String?
  severity   HallucinationSeverity @default(MEDIUM)
  status     HallucinationStatus   @default(OPEN)

  created_at DateTime  @default(now())
  fixed_at   DateTime?

  email    Email             @relation(fields: [email_id], references: [id])
  reply    AiGeneratedReply? @relation(fields: [reply_id], references: [id])
  user     User              @relation(fields: [user_id], references: [id])
  business Business          @relation(fields: [business_id], references: [id])
}

model AiModelSettings {
  id             Int     @id @default(autoincrement())
  model_name     String
  temperature    Float?  @default(0.7)
  max_tokens     Int?    @default(2048)
  system_prompt  String?
  safety_rules   Json?
  fallback_model String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

///////////////////////////////
// INTEGRATION
///////////////////////////////

model Integration {
  id                Int             @id @default(autoincrement())
  business_id       Int
  type              IntegrationType
  config_json       Json?
  last_sync_at      DateTime?
  auto_sync_enabled Boolean         @default(false)

  business Business @relation(fields: [business_id], references: [id])
}

///////////////////////////////
// BILLING SYSTEM (FINAL)
///////////////////////////////

model Plan {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  price       Float
  currency    String  @default("usd")
  interval    String  @default("month") // month | year
  email_limit Int?
  ai_credits  Int?
  features    Json?
  is_active   Boolean @default(true)

  // Stripe
  stripe_product_id String?
  stripe_price_id   String?

  subscriptions Subscription[]
  payments      PaymentHistory[]
}

model Subscription {
  id           Int       @id @default(autoincrement())
  business_id  Int
  plan_id      Int
  status       String    @default("ACTIVE")
  start_date   DateTime?
  end_date     DateTime?
  renewal_date DateTime?

  // Stripe fields
  stripe_customer_id     String?
  stripe_subscription_id String?

  business Business         @relation(fields: [business_id], references: [id])
  plan     Plan             @relation(fields: [plan_id], references: [id])
  payments PaymentHistory[]

  @@unique([business_id, plan_id], name: "business_id_plan_id")
}

model PaymentHistory {
  id              Int  @id @default(autoincrement())
  business_id     Int
  plan_id         Int
  subscription_id Int?

  amount         Float
  currency       String
  payment_method String
  invoice_url    String?
  status         String // PAID, FAILED, PENDING
  created_at     DateTime @default(now())

  // Stripe references
  stripe_invoice_id        String?
  stripe_payment_intent_id String?

  business     Business      @relation(fields: [business_id], references: [id])
  plan         Plan          @relation(fields: [plan_id], references: [id])
  subscription Subscription? @relation(fields: [subscription_id], references: [id])

  @@index([business_id])
  @@index([plan_id])
}
