generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Business {
  id                    Int                    @id @default(autoincrement())
  name                  String
  website               String?
  address               String?
  primary_contact_email String?
  status                String?
  created_at            DateTime               @default(now())
  updated_at            DateTime               @updatedAt
  credits               BusinessCredits?
  settings              BusinessSettings?
  subscriptions         BusinessSubscription[]
}

model BusinessSubscription {
  id                Int                @id @default(autoincrement())
  business_id       Int
  plan_id           Int
  billing_cycle     BillingCycle
  status            SubscriptionStatus
  start_date        DateTime?
  end_date          DateTime?
  next_billing_date DateTime?
  business          Business           @relation(fields: [business_id], references: [id])
  plan              SubscriptionPlan   @relation(fields: [plan_id], references: [id])
}

model SubscriptionPlan {
  id            Int                    @id @default(autoincrement())
  name          String
  description   String?
  price_cents   Int
  billing_cycle BillingCycle
  features_json Json?
  subscriptions BusinessSubscription[]
}

model Invoice {
  id                       Int       @id @default(autoincrement())
  business_subscription_id Int
  amount_cents             Int
  issued_at                DateTime?
  due_at                   DateTime?
  paid_at                  DateTime?
  status                   String?
}

model BusinessCredits {
  id            Int       @id @default(autoincrement())
  business_id   Int       @unique
  total_credits Int?
  used_credits  Int?
  period_start  DateTime?
  period_end    DateTime?
  business      Business  @relation(fields: [business_id], references: [id])
}

model BusinessSettings {
  id                       Int      @id @default(autoincrement())
  business_id              Int      @unique
  primary_colour           String?
  secondary_colour         String?
  accent_colour            String?
  logo_url                 String?
  timezone                 String?
  show_logo_in_sidebar     Boolean? @default(false)
  compact_mode             Boolean? @default(false)
  show_performance_metrics Boolean? @default(true)
  business                 Business @relation(fields: [business_id], references: [id])
}

model Role {
  id          Int               @id @default(autoincrement())
  name        String
  scope       Scope
  description String?
  permissions RolePermissions[]
}

model Permission {
  id          Int               @id @default(autoincrement())
  name        String
  description String?
  roles       RolePermissions[]
}

model RolePermissions {
  role_id       Int
  permission_id Int
  permission    Permission @relation(fields: [permission_id], references: [id])
  role          Role       @relation(fields: [role_id], references: [id])

  @@id([role_id, permission_id])
}

model User {
  id                 Int       @id @default(autoincrement())
  email              String    @unique
  name               String
  refreshToken       String?
  business_id        Int?
  created_at         DateTime  @default(now())
  last_login_at      DateTime?
  password_hash      String
  role_id            Int
  two_factor_enabled Boolean   @default(false)
  updated_at         DateTime  @updatedAt
  status             String?
}

model LoginLog {
  id         Int      @id @default(autoincrement())
  user_id    Int?
  timestamp  DateTime @default(now())
  location   String?
  ip_address String?
  status     String?
  user_agent String?
}

model ActivityLog {
  id            Int      @id @default(autoincrement())
  business_id   Int?
  user_id       Int
  action        String
  resource_type String?
  resource_id   Int?
  description   String?
  ip_address    String?
  created_at    DateTime @default(now())
}

model Mailbox {
  id            Int       @id @default(autoincrement())
  business_id   Int
  user_id       Int
  provider      String
  email_address String
  imap_host     String?
  imap_port     Int?
  smtp_host     String?
  smtp_port     Int?
  is_ssl        Boolean?
  access_token  String?
  refresh_token String?
  connected_at  DateTime?
  last_sync_at  DateTime?
  status        String?
}

model EmailThread {
  id              Int       @id @default(autoincrement())
  business_id     Int
  mailbox_id      Int
  customer_id     Int?
  subject         String?
  last_message_at DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
}

model Email {
  id            Int          @id @default(autoincrement())
  business_id   Int
  thread_id     Int
  mailbox_id    Int
  user_id       Int
  message_id    String?
  in_reply_to   String?
  from_address  String?
  to_addresses  Json?
  cc_addresses  Json?
  bcc_addresses Json?
  subject       String?
  body_html     String?
  body_text     String?
  folder        EmailFolder?
  is_read       Boolean?     @default(false)
  is_starred    Boolean?     @default(false)
  received_at   DateTime?
  sent_at       DateTime?
  created_at    DateTime     @default(now())
  updated_at    DateTime     @updatedAt
}

model EmailAttachment {
  id          Int      @id @default(autoincrement())
  email_id    Int
  file_name   String
  mime_type   String?
  file_size   Int?
  storage_url String
  created_at  DateTime @default(now())
}

model Label {
  id          Int     @id @default(autoincrement())
  business_id Int
  name        String
  colour      String?
  description String?
}

model EmailLabel {
  email_id Int
  label_id Int

  @@id([email_id, label_id])
}

model Customer {
  id              Int       @id @default(autoincrement())
  business_id     Int
  name            String
  email           String?
  phone           String?
  status          String?
  lead_score      Int?
  value_estimate  Float?
  last_contact_at DateTime?
}

model Opportunity {
  id              Int              @id @default(autoincrement())
  business_id     Int
  customer_id     Int
  name            String
  stage           OpportunityStage
  value_amount    Float?
  status          String?
  won_lost_reason String?
  close_date      DateTime?
  created_at      DateTime         @default(now())
}

model AIEmailInsight {
  id                Int      @id @default(autoincrement())
  email_id          Int      @unique
  summary           String?
  suggested_actions String?
  lead_score        Int?
  contact_email     String?
  meta_json         Json?
  created_at        DateTime @default(now())
}

model AIAction {
  id             Int          @id @default(autoincrement())
  email_id       Int
  user_id        Int?
  action_type    AIActionType
  input_snapshot Json?
  output_data    Json?
  created_at     DateTime     @default(now())
}

model Dataset {
  id           Int     @id @default(autoincrement())
  business_id  Int
  name         String
  type         String?
  size_gb      Float?
  record_count Int?
  status       String?
}

model TrainingDocument {
  id          Int      @id @default(autoincrement())
  business_id Int
  dataset_id  Int?
  file_name   String
  file_type   String?
  file_size   Int?
  storage_url String
  category    String?
  tags        String?
  uploaded_at DateTime @default(now())
}

model AITrainingAuditLog {
  id                   Int      @id @default(autoincrement())
  business_id          Int
  dataset_id           Int?
  training_document_id Int?
  admin_user_id        Int
  action               String
  data_type            String?
  details              String?
  timestamp            DateTime @default(now())
  status               String?
}

model AIModel {
  id                Int     @id @default(autoincrement())
  name              String
  provider          String?
  status            String?
  usage_percent     Float?
  uptime_percent    Float?
  avg_response_time Float?
  overall_accuracy  Float?
  cost_per_1k       Float?
}

model SystemPrompt {
  id             Int      @id @default(autoincrement())
  business_id    Int?
  name           String
  description    String?
  prompt_content String
  scope          Scope
  status         String?
  created_by     Int
  created_at     DateTime @default(now())
}

model ModelPrompt {
  model_id  Int
  prompt_id Int

  @@id([model_id, prompt_id])
}

model Integration {
  id                Int             @id @default(autoincrement())
  business_id       Int
  type              IntegrationType
  status            String?
  config_json       Json?
  last_sync_at      DateTime?
  auto_sync_enabled Boolean         @default(false)
}

model BusinessNotificationRule {
  id                     Int     @id @default(autoincrement())
  business_id            Int
  rule_name              String
  trigger_type           String
  trigger_condition_json Json?
  action_type            String
  action_config_json     Json?
  status                 String?
}

model PlatformApiKey {
  id           Int       @id @default(autoincrement())
  business_id  Int?
  name         String
  api_key_hash String
  permissions  Json?
  created_at   DateTime  @default(now())
  last_used_at DateTime?
  status       String?
}

model PlatformSecuritySettings {
  id                      Int      @id @default(autoincrement())
  enforce_https           Boolean? @default(true)
  rate_limit_per_minute   Int?
  ddos_protection_enabled Boolean? @default(true)
  waf_enabled             Boolean? @default(true)
}

model ComplianceSettings {
  id                         Int      @id @default(autoincrement())
  gdpr_enabled               Boolean? @default(true)
  ccpa_enabled               Boolean? @default(false)
  hipaa_enabled              Boolean? @default(false)
  sox_enabled                Boolean? @default(false)
  privacy_policy_url         String?
  terms_of_service_url       String?
  data_retention_period_days Int?
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  TRIALING
  EXPIRED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum EmailFolder {
  INBOX
  SENT
  DRAFT
  TRASH
  SPAM
}

enum OpportunityStage {
  LEAD
  PROPOSAL
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

enum AIActionType {
  SUMMARY
  REPLY_DRAFT
  SENTIMENT
  CLASSIFICATION
  FOLLOWUP_SUGGESTION
}

enum Scope {
  PLATFORM
  BUSINESS
}

enum IntegrationType {
  GOOGLE_DRIVE
  TRELLO
  GOOGLE_CALENDAR
  OUTLOOK_CALENDAR
  ICAL
  SLACK
  SMS
}
